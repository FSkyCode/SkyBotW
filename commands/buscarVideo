import axios from "axios";
import fs from "fs";
import path from "path";

export default async function handler(sock, msg) {
  const body =
    msg.message.conversation ||
    msg.message.extendedTextMessage?.text ||
    "";
  
  const args = body.trim().split(" ");
  const comando = args.shift()?.toLowerCase();

  // === COMANDO: !video <texto> ===
  if (comando === "!video") {
    if (args.length === 0) {
      return sock.sendMessage(msg.key.remoteJid, { text: "‚ùó Usa: !video <busqueda>" });
    }

    const consulta = args.join(" ");

    await sock.sendMessage(msg.key.remoteJid, { text: `üîç Buscando video: ${consulta}...` });

    try {
      // --- EJEMPLO DE BUSCADOR (c√°mbialo por lo que uses) ---
      // Obtiene un video random permitido
      const urlAPI = `https://api.pexels.com/videos/search?query=${encodeURIComponent(consulta)}&per_page=1`;

      const res = await axios.get(urlAPI, {
        headers: { Authorization: "563492ad6f9170000100000123456789abcdef12" } // clave de ejemplo
      });

      if (!res.data.videos?.length) {
        return sock.sendMessage(msg.key.remoteJid, { text: "‚ö†Ô∏è No encontr√© ning√∫n video." });
      }

      const videoURL = res.data.videos[0].video_files[0].link;

      // Descarga archivo en /tmp
      const filePath = path.join("./data", "tempVideo.mp4");
      const file = fs.createWriteStream(filePath);

      const download = await axios({
        url: videoURL,
        method: "GET",
        responseType: "stream"
      });

      download.data.pipe(file);

      file.on("finish", async () => {
        await sock.sendMessage(
          msg.key.remoteJid,
          {
            video: fs.readFileSync(filePath),
            caption: `üé¨ Resultado para: ${consulta}`
          }
        );

        fs.unlinkSync(filePath);
      });

    } catch (err) {
      console.log(err);
      await sock.sendMessage(msg.key.remoteJid, { text: "‚ùó Error buscando o enviando el video." });
    }
  }
}